name: Build Windows

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install dependencies
        run: npm ci

      - name: Build Tauri app
        run: npm run tauri:build -- --bundles none

      - name: Install Enigma Virtual Box
        shell: pwsh
        run: |
          # Download EVB installer
          $evbUrl = "https://enigmaprotector.com/assets/files/enigmavb.exe"
          $evbInstaller = Join-Path $env:RUNNER_TEMP "enigmavb_setup.exe"
          Remove-Item -Path $evbInstaller -Force -ErrorAction SilentlyContinue
          $downloaded = $false
          for ($attempt = 1; $attempt -le 3; $attempt++) {
            if (Get-Command curl.exe -ErrorAction SilentlyContinue) {
              curl.exe -L --retry 3 --retry-delay 2 --retry-all-errors --output $evbInstaller $evbUrl
            } else {
              Invoke-WebRequest -Uri $evbUrl -OutFile $evbInstaller -UseBasicParsing
            }
            if ((Test-Path $evbInstaller) -and (Get-Item $evbInstaller).Length -gt 1MB) {
              $downloaded = $true
              break
            }
            Start-Sleep -Seconds 2
          }
          if (-not $downloaded) {
            throw "Failed to download a valid EVB installer"
          }

          # Install silently
          $process = Start-Process -FilePath $evbInstaller -ArgumentList "/VERYSILENT","/NORESTART" -Wait -PassThru
          if ($process.ExitCode -ne 0) {
            throw "EVB installer failed with exit code $($process.ExitCode)"
          }

          # Verify
          if (Test-Path "C:\Program Files (x86)\Enigma Virtual Box\enigmavbconsole.exe") {
            Write-Host "EVB installed successfully"
          } else {
            throw "EVB installation failed"
          }

      - name: Create portable exe
        shell: pwsh
        run: |
          # Install @insco/enigma-virtualbox CLI globally
          npm install -g @insco/enigma-virtualbox
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to install @insco/enigma-virtualbox"
          }

          $inputExe = Resolve-Path "src-tauri\target\release\Benchmaker.exe"
          $outputExe = Join-Path $PWD "src-tauri\target\release\Benchmaker-Portable.exe"
          $webviewDll = Get-ChildItem -Path "src-tauri\target" -Filter "WebView2Loader.dll" -Recurse | Select-Object -First 1
          if (-not $webviewDll) {
            throw "WebView2Loader.dll not found under src-tauri\\target"
          }
          $webviewDllPath = $webviewDll.FullName

          # Use enigmavirtualbox to generate a compatible EVB project file
          $evbStaging = Join-Path $PWD "evb-staging"
          New-Item -ItemType Directory -Force -Path $evbStaging | Out-Null
          Copy-Item -Path $webviewDllPath -Destination $evbStaging -Force
          $evbProject = Join-Path $PWD "Benchmaker.evb"
          enigmavirtualbox generate $evbStaging --input $inputExe --output $outputExe --project-name $evbProject
          if ($LASTEXITCODE -ne 0) {
            throw "enigmavirtualbox generate failed"
          }
          $evbConsole = "C:\Program Files (x86)\Enigma Virtual Box\enigmavbconsole.exe"
          if (-not (Test-Path $evbConsole)) {
            throw "enigmavbconsole.exe not found at $evbConsole"
          }
          & $evbConsole $evbProject
          if ($LASTEXITCODE -ne 0) {
            throw "enigmavbconsole failed"
          }

          # Verify output
          if (Test-Path $outputExe) {
            $size = [math]::Round((Get-Item $outputExe).Length / 1MB, 2)
            Write-Host "Portable exe created: $size MB"
          } else {
            throw "Failed to create portable exe"
          }

      - name: Upload portable exe
        uses: actions/upload-artifact@v4
        with:
          name: Benchmaker-Portable
          path: src-tauri/target/release/Benchmaker-Portable.exe

      - name: Determine release tag
        id: release_tag
        if: github.ref == 'refs/heads/main'
        shell: pwsh
        run: |
          $version = (Get-Content package.json | ConvertFrom-Json).version
          if (-not $version) {
            throw "package.json version not found"
          }
          "version=$version" >> $env:GITHUB_OUTPUT
          "tag=v$version" >> $env:GITHUB_OUTPUT

      - name: Check for existing release
        id: release_check
        if: github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ steps.release_tag.outputs.tag }}';
            try {
              await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag
              });
              core.setOutput('exists', 'true');
            } catch (error) {
              core.setOutput('exists', 'false');
            }

      - name: Create GitHub release
        if: github.ref == 'refs/heads/main' && steps.release_check.outputs.exists != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.tag }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          files: src-tauri/target/release/Benchmaker-Portable.exe
